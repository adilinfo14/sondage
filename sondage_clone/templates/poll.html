{% extends "base.html" %}

{% block content %}
<section class="card hero">
    <p class="eyebrow">{% if admin_mode %}üîó Lien de partage{% else %}üó≥Ô∏è Sondage{% endif %}</p>
    <h1>{{ poll.title }}</h1>
    {% if poll.description %}
    <p class="sub">{{ poll.description }}</p>
    {% endif %}
    <p class="meta meta-inline">
        {{ poll_type_labels.get(poll.poll_type, poll.poll_type) }} ¬∑ {{ poll_response_mode_label }}
        {% if poll.deadline_at %}
        ¬∑ Date limite: {{ poll.deadline_at | datetime_fr }} {% if closed %}(cl√¥tur√©){% endif %}
        {% endif %}
    </p>
    {% if admin_mode %}
    <div class="share-box">
        <input id="shareUrl" type="text" readonly value="{{ poll_url }}">
        <button type="button" id="copyLinkBtn">Copier le lien</button>
    </div>
    <p class="meta"><a href="{{ url_for('home') }}">Cr√©er un nouveau sondage</a></p>
    {% endif %}
    {% if poll.creator_name %}
    <p class="meta">Organis√© par {{ poll.creator_name }}</p>
    {% endif %}
</section>

<section class="card">
    <h2>{% if closed %}Votes ferm√©s{% else %}Voter{% endif %}</h2>
    {% if closed %}
    {% if is_archived %}
    <p>Ce sondage est archiv√©, les votes sont ferm√©s.</p>
    {% else %}
    <p>La date limite est d√©pass√©e, le sondage est cl√¥tur√©.</p>
    {% endif %}
    {% elif organizer_has_voted and not show_vote_form %}
    <p>Vote organisateur d√©j√† enregistr√©.</p>
    <p><a href="{{ url_for('view_poll', token=poll.token, edit=1) }}">Modifier mon vote</a></p>
    {% elif voter_has_voted and not show_vote_form %}
    <p>Ton vote est enregistr√© pour <strong>{{ voter_identity_label }}</strong>.</p>
    <p><a href="{{ url_for('view_poll', token=poll.token, edit=1) }}">Modifier mon vote</a></p>
    {% else %}
    <form action="{{ url_for('vote', token=poll.token) }}" method="post" class="vote-form"
        data-vote-status-url="{{ url_for('vote_status', token=poll.token) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="vote-identity-grid">
            <label>
                Nom et pr√©nom
                <input type="text" name="participant_name" placeholder="Ex: Pr√©nom Nom"
                    value="{{ organizer_prefill_name }}" required>
            </label>

            <label>
                <span class="field-label-row">
                    <span>Email</span>
                    <span class="meta field-inline-meta">Optionnel (utile pour √©viter les doublons).</span>
                </span>
                <input type="email" name="participant_email" placeholder="Ex: prenom@email.com"
                    value="{{ organizer_prefill_email }}">
            </label>
        </div>

        <p id="voteStatusMessage" class="meta" aria-live="polite"></p>

        {% if poll_response_mode == 'single' %}
        <div class="slot-grid">
            {% for slot in slots %}
            <label class="slot-item vote-choice-card" style="display:flex;align-items:center;gap:10px;">
                <input type="radio" name="selected_slot" value="{{ slot.id }}" {% if
                    existing_choice_by_slot.get(slot.id, 'no' )=='yes' %}checked{% elif not edit_vote_mode and
                    loop.first %}checked{% endif %}>
                <span class="slot-label vote-choice-label" style="margin-left:0;">{{ slot.label }}</span>
            </label>
            {% endfor %}
        </div>
        {% else %}
        <div class="slot-grid">
            {% for slot in slots %}
            <label class="slot-item vote-choice-card" style="display:flex;align-items:center;gap:10px;">
                <input type="checkbox" name="selected_slots" value="{{ slot.id }}" {% if
                    existing_choice_by_slot.get(slot.id, 'no' )=='yes' %}checked{% endif %}>
                <span class="slot-label vote-choice-label" style="margin-left:0;">{{ slot.label }}</span>
            </label>
            {% endfor %}
        </div>
        {% endif %}

        <label>
            Commentaire (optionnel)
            <textarea name="comment" rows="2" maxlength="280"
                placeholder="Ton avis en une phrase...">{{ existing_comment }}</textarea>
        </label>

        <label class="consent-row">
            <input type="checkbox" name="rgpd_vote" required>
            <span>J‚Äôaccepte la <a href="{{ url_for('privacy_policy') }}" target="_blank" rel="noopener">politique de
                    confidentialit√© (RGPD)</a> (version {{ consent_version }}).</span>
        </label>

        <label class="consent-row">
            <input type="checkbox" name="replace_existing_vote" {% if replace_vote_default_checked %}checked{% endif %}>
            <span>Modifier mon vote existant (si j‚Äôai d√©j√† vot√©).</span>
        </label>

        <button type="submit">Enregistrer mon vote</button>
    </form>
    {% endif %}
</section>

{% if admin_mode %}
<section class="card">
    <h2>D√©tail des r√©ponses (organisateur)</h2>
    {% if participants %}
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Participant</th>
                    <th>Commentaire</th>
                    {% for slot in slots %}
                    <th>{{ slot.label }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td>{{ participant_labels.get(participant, participant) }}</td>
                    <td>{{ comments.get(participant, '-') }}</td>
                    {% for slot in slots %}
                    {% set choice = matrix[participant].get(slot.id, '') %}
                    <td>
                        {% if choice == 'yes' %}
                        ‚úÖ
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Aucun vote pour l‚Äôinstant.</p>
    {% endif %}

    {% if not is_poll_owner %}
    <form action="{{ url_for('admin_logout', token=poll.token) }}" method="post" class="inline-form"
        style="margin-top:12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Quitter le mode organisateur</button>
    </form>
    {% endif %}
</section>
{% endif %}

<section class="card">
    <h2>R√©sultats globaux</h2>
    {% set ns = namespace(total_yes=0) %}
    {% for item in summary %}
    {% set ns.total_yes = ns.total_yes + item.yes_count %}
    {% endfor %}
    <div class="results-grid">
        {% for row in summary %}
        {% set rank = loop.index %}
        {% set rank_label = (rank ~ 'er') if rank == 1 else (rank ~ '√®me') %}
        {% set share_percent = ((row.yes_count * 100) / ns.total_yes) if ns.total_yes > 0 else 0 %}
        {% set share_percent_display = share_percent | round(1) %}
        {% set share_width = 6 if row.yes_count > 0 and share_percent < 6 else (share_percent | round(2)) %} <article
            class="result-card result-visual-card">
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                <span class="result-rank">{{ rank_label }}</span>
                <span class="slot-label" style="font-weight:600;">{{ row.label }}</span>
                <span class="result-metrics" style="margin-left:auto;gap:10px;">
                    üó≥Ô∏è <strong>{{ row.yes_count }}</strong> &nbsp; üìä <strong>{{ share_percent_display }}%</strong>
                </span>
            </div>
            <progress class="result-progress" value="{{ share_percent_display }}" max="100"
                aria-label="{{ row.label }}: part {{ share_percent_display }}%"></progress>
            </article>
            {% endfor %}
    </div>
</section>

{% if not admin_mode %}
<details class="card organizer-details">
    <summary>Acc√®s organisateur</summary>
    <form action="{{ url_for('admin_login', token=poll.token) }}" method="post" class="inline-form"
        style="margin-top:12px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="password" name="organizer_code" placeholder="Code organisateur" required>
        <button type="submit">Acc√©der aux r√©sultats d√©taill√©s</button>
    </form>
</details>
{% endif %}
{% endblock %}