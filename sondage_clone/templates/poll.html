{% extends "base.html" %}

{% block content %}
<section class="card hero">
    <p class="eyebrow">ğŸ”— Lien de partage</p>
    <h1>{{ poll.title }}</h1>
    {% if poll.description %}
    <p class="sub">{{ poll.description }}</p>
    {% endif %}
    <p class="meta">Type: {% if poll.poll_type == 'opinion' %}ğŸ’¡ Avis / dÃ©cision{% else %}ğŸ“… Prise de RDV{% endif %}</p>
    {% if poll.deadline_at %}
    <p class="meta">Date limite: {{ poll.deadline_at.replace('T', ' ') }} {% if closed %}(clÃ´turÃ©){% endif %}</p>
    {% endif %}
    <div class="share-box">
        <input id="shareUrl" type="text" readonly value="{{ poll_url }}">
        <button type="button" id="copyLinkBtn">Copier le lien</button>
    </div>
    {% if poll.creator_name %}
    <p class="meta">OrganisÃ© par {{ poll.creator_name }}</p>
    {% endif %}
</section>

<section class="card">
    {% if admin_mode %}
    <h2>Mode organisateur âœ…</h2>
    <form action="{{ url_for('admin_logout', token=poll.token) }}" method="post" class="inline-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit">Quitter le mode organisateur</button>
    </form>
    {% else %}
    <h2>AccÃ¨s organisateur</h2>
    <form action="{{ url_for('admin_login', token=poll.token) }}" method="post" class="inline-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="password" name="organizer_code" placeholder="Code organisateur" required>
        <button type="submit">Voir les rÃ©sultats dÃ©taillÃ©s</button>
    </form>
    {% endif %}
</section>

{% if top_choice %}
<section class="card">
    <h2>Meilleure option actuelle</h2>
    <article class="result-card best-choice">
        <p class="slot-label">{{ top_choice.label }}</p>
        <p>âœ… Oui: <strong>{{ top_choice.yes_count }}</strong> | ğŸ¤” Peut-Ãªtre: <strong>{{ top_choice.maybe_count
                }}</strong> | âŒ Non: <strong>{{ top_choice.no_count }}</strong></p>
    </article>
</section>
{% endif %}

<section class="card">
    <h2>{% if closed %}Votes fermÃ©s{% else %}Voter{% endif %}</h2>
    {% if closed %}
    <p>La date limite est dÃ©passÃ©e, le sondage est clÃ´turÃ©.</p>
    {% else %}
    <form action="{{ url_for('vote', token=poll.token) }}" method="post" class="vote-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>
            Ton nom
            <input type="text" name="participant_name" placeholder="Ex: Sarah" required>
        </label>

        <label>
            Commentaire / avis (optionnel)
            <textarea name="comment" rows="2" maxlength="280"
                placeholder="Ex: Je prÃ©fÃ¨re le matin, ou Option B pour son coÃ»t."></textarea>
        </label>

        <div class="slot-grid">
            {% for slot in slots %}
            <div class="slot-item">
                <p class="slot-label">{{ slot.label }}</p>
                <select name="choice_{{ slot.id }}">
                    {% if poll.poll_type == 'opinion' %}
                    <option value="yes">ğŸ‘ Pour</option>
                    <option value="maybe">ğŸ¤” MitigÃ©</option>
                    <option value="no" selected>ğŸ‘ Contre</option>
                    {% else %}
                    <option value="yes">âœ… Oui</option>
                    <option value="maybe">ğŸ¤” Peut-Ãªtre</option>
                    <option value="no" selected>âŒ Non</option>
                    {% endif %}
                </select>
            </div>
            {% endfor %}
        </div>

        <button type="submit">Enregistrer mon vote</button>
    </form>
    {% endif %}
</section>

<section class="card">
    <h2>RÃ©sultats globaux</h2>
    <div class="results-grid">
        {% for row in summary %}
        <article class="result-card">
            <p class="slot-label">{{ row.label }}</p>
            <p>âœ… Oui: <strong>{{ row.yes_count }}</strong></p>
            <p>ğŸ¤” Peut-Ãªtre: <strong>{{ row.maybe_count }}</strong></p>
            <p>âŒ Non: <strong>{{ row.no_count }}</strong></p>
        </article>
        {% endfor %}
    </div>
</section>

{% if admin_mode %}
<section class="card">
    <h2>DÃ©tail des rÃ©ponses (organisateur)</h2>
    {% if participants %}
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th>Participant</th>
                    <th>Commentaire</th>
                    {% for slot in slots %}
                    <th>{{ slot.label }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for participant in participants %}
                <tr>
                    <td>{{ participant }}</td>
                    <td>{{ comments.get(participant, '-') }}</td>
                    {% for slot in slots %}
                    {% set choice = matrix[participant].get(slot.id, 'no') %}
                    <td>
                        {% if choice == 'yes' %}
                        âœ…
                        {% elif choice == 'maybe' %}
                        ğŸ¤”
                        {% else %}
                        âŒ
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>Aucun vote pour lâ€™instant.</p>
    {% endif %}
</section>
{% endif %}
{% endblock %}